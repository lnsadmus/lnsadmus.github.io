<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPB Dashboard ‚Ä¢ Intelligence par la Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Space+Grotesk:wght@500;600&amp;display=swap');
        
        :root {
            --primary: 234 179 8;
        }
        
        body {
            font-family: 'Inter', system_ui, sans-serif;
        }
        
        .title-font {
            font-family: 'Space Grotesk', sans-serif;
        }

        .card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            transform: translateY(-4px);
        }

        .chart-container {
            position: relative;
        }

        table {
            border-collapse: collapse;
        }
        
        th, td {
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-200">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="border-b border-zinc-800 bg-zinc-900">
            <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
                <div class="flex items-center gap-x-4">
                    <div class="w-9 h-9 bg-emerald-500 rounded-2xl flex items-center justify-center text-white font-bold text-xl">IPB</div>
                    <div>
                        <h1 class="title-font text-3xl font-semibold tracking-tight text-white">Intelligence par la Base</h1>
                        <p class="text-emerald-400 text-sm -mt-1">Analyse des r√©alit√©s de terrain en RCA</p>
                    </div>
                </div>
                <div class="text-xs text-zinc-500 flex items-center gap-x-2">
                    <div class="px-3 py-1 bg-zinc-800 rounded-full flex items-center gap-x-1">
                        <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                        Donn√©es en direct
                    </div>
                    <span id="last-updated" class="text-zinc-500"></span>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <!-- Metrics -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="metrics">
                <!-- Populated by JS -->
            </div>

            <!-- Filters -->
            <div class="mt-10 bg-zinc-900 border border-zinc-800 rounded-3xl p-6">
                <div class="flex flex-wrap items-end gap-4">
                    <div class="flex-1 min-w-[180px]">
                        <label class="block text-xs font-medium text-zinc-400 mb-2">NIVEAU D'URGENCE</label>
                        <select id="urgency-filter" onchange="updateDashboard()" 
                                class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-2xl px-4 py-3 focus:outline-none focus:border-emerald-500 transition-colors">
                            <option value="">Tous les niveaux</option>
                        </select>
                    </div>
                    
                    <div class="flex-1 min-w-[180px]">
                        <label class="block text-xs font-medium text-zinc-400 mb-2">TH√àME / TAG</label>
                        <select id="theme-filter" onchange="updateDashboard()" 
                                class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-2xl px-4 py-3 focus:outline-none focus:border-emerald-500 transition-colors">
                            <option value="">Tous les th√®mes</option>
                        </select>
                    </div>
                    
                    <div class="flex-1 min-w-[180px]">
                        <label class="block text-xs font-medium text-zinc-400 mb-2">PLATEFORME</label>
                        <select id="platform-filter" onchange="updateDashboard()" 
                                class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-2xl px-4 py-3 focus:outline-none focus:border-emerald-500 transition-colors">
                            <option value="">Toutes les plateformes</option>
                        </select>
                    </div>

                    <button onclick="resetFilters()" 
                            class="px-6 py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-2xl text-sm font-medium transition-colors flex items-center gap-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.058 11H1M12 3v2m0 16v2m9-9H15m-6 0H3" />
                        </svg>
                        R√©initialiser
                    </button>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-10">
                <!-- Tags Chart -->
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-semibold text-lg">Distribution des th√®mes</h3>
                            <p class="text-xs text-zinc-400">Les probl√®mes les plus document√©s</p>
                        </div>
                        <div class="text-emerald-400 text-2xl">üìä</div>
                    </div>
                    <div class="chart-container h-72">
                        <canvas id="tagsChart"></canvas>
                    </div>
                </div>

                <!-- Content Type Chart -->
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-semibold text-lg">Type de contenu</h3>
                            <p class="text-xs text-zinc-400">R√©partition des formats</p>
                        </div>
                        <div class="text-emerald-400 text-2xl">üìπ</div>
                    </div>
                    <div class="chart-container h-72">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>

                <!-- Urgency Chart -->
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-semibold text-lg">Niveau d'urgence</h3>
                            <p class="text-xs text-zinc-400">Gravit√© des signalements</p>
                        </div>
                        <div class="text-emerald-400 text-2xl">‚ö†Ô∏è</div>
                    </div>
                    <div class="chart-container h-72">
                        <canvas id="urgencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Submissions Table -->
            <div class="mt-12">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold">Soumissions r√©centes</h2>
                        <p class="text-zinc-400 text-sm">15 derni√®res entr√©es (tri√©es par date)</p>
                    </div>
                    <div id="table-count" class="text-sm text-zinc-400"></div>
                </div>
                
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-zinc-800 text-xs uppercase tracking-wider text-zinc-400">
                                <th class="px-8 py-5 text-left font-medium">Date</th>
                                <th class="px-8 py-5 text-left font-medium">R√©sum√©</th>
                                <th class="px-8 py-5 text-left font-medium">Th√®mes</th>
                                <th class="px-8 py-5 text-left font-medium">Urgence</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-zinc-800 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Error overlay -->
    <div id="error-overlay" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-zinc-900 border border-red-500 rounded-3xl max-w-md p-8 text-center">
            <div class="text-red-400 text-5xl mb-4">‚ö†Ô∏è</div>
            <h3 class="text-xl font-semibold mb-2">Impossible de charger les donn√©es</h3>
            <p class="text-zinc-400 mb-6" id="error-message">V√©rifiez votre connexion internet et rechargez la page.</p>
            <button onclick="location.reload()" 
                    class="px-8 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-white font-medium transition-colors">
                R√©essayer
            </button>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb6ZvGw9im_FrK9riRIUwe5vQ3YBJ5dOknOhC7T4bYchlK_1I9nSJ7nM0Es4jzHmYDO7hDUfxn94HY/pub?gid=137328810&single=true&output=csv";
        
        const THEME_COLUMNS = [
            "Th√®mes 2/ Tags principaux",
            "Th√®mes 3/ Tags principaux",
            "Th√®mes 4/ Tags principaux",
            "Th√®mes 5/ Tags principaux",
            "Th√®mes 6/ Tags principaux",
            "Th√®mes 8/ Tags principaux",
            "Th√®mes 7/ Tags principaux",
            "Th√®mes 9/ Tags principaux"
        ];

        // ==================== CSV PARSER ====================
        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let row = 0;
            let col = 0;
            for (let i = 0; i < str.length; i++) {
                const cc = str[i];
                const nc = str[i + 1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';
                
                if (cc === '"' && quote && nc === '"') {
                    arr[row][col] += cc;
                    i++;
                    continue;
                }
                if (cc === '"') {
                    quote = !quote;
                    continue;
                }
                if (cc === ',' && !quote) {
                    col++;
                    continue;
                }
                if (cc === '\r' && nc === '\n' && !quote) {
                    i++;
                    row++;
                    col = 0;
                    continue;
                }
                if (cc === '\n' && !quote) {
                    row++;
                    col = 0;
                    continue;
                }
                if (cc === '\r' && !quote) {
                    row++;
                    col = 0;
                    continue;
                }
                arr[row][col] += cc;
            }
            return arr;
        }

        // ==================== DATA HELPERS ====================
        let allData = [];
        let tagsChartInstance = null;
        let typeChartInstance = null;
        let urgencyChartInstance = null;

        function getAllTags(row) {
            const tags = new Set();
            THEME_COLUMNS.forEach(col => {
                const cell = row[col];
                if (cell) {
                    const parts = cell.split(/\s+/);
                    parts.forEach(p => {
                        const trimmed = p.trim();
                        if (trimmed.startsWith('#') && trimmed.length > 1) {
                            tags.add(trimmed);
                        }
                    });
                }
            });
            return Array.from(tags);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // ==================== RENDER METRICS ====================
        function renderMetrics(filtered) {
            const total = filtered.length;
            const uniqueSubmitters = new Set(filtered.map(r => r["Votre nom complet"]).filter(Boolean)).size;
            
            // Urgent count
            const urgentCount = filtered.filter(r => 
                r["Niveau d'urgence / Cat√©gorie"] === "Urgent / Appel √† l'aide"
            ).length;

            // Most frequent tag
            const tagCounts = {};
            filtered.forEach(row => {
                getAllTags(row).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
            const mostFreqTag = sortedTags.length ? `${sortedTags[0][0]} <span class="text-emerald-400">(${sortedTags[0][1]})</span>` : '‚Äî';

            const metricsHTML = `
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card">
                    <div class="text-emerald-400 text-4xl font-bold mb-1" id="total-count">${total}</div>
                    <div class="text-zinc-400 text-sm">Soumissions totales</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card">
                    <div class="text-white text-4xl font-bold mb-1">${uniqueSubmitters}</div>
                    <div class="text-zinc-400 text-sm">Contributeurs uniques</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card">
                    <div class="text-amber-400 text-4xl font-bold mb-1">${mostFreqTag}</div>
                    <div class="text-zinc-400 text-sm">Th√®me le plus fr√©quent</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card relative overflow-hidden">
                    <div class="text-red-400 text-4xl font-bold mb-1">${urgentCount}</div>
                    <div class="text-zinc-400 text-sm">Appels √† l'aide urgents</div>
                    ${urgentCount > 0 ? `<div class="absolute top-4 right-4 text-xs bg-red-500/10 text-red-400 px-3 py-1 rounded-full">Priorit√©</div>` : ''}
                </div>
            `;
            
            document.getElementById('metrics').innerHTML = metricsHTML;
        }

        // ==================== RENDER CHARTS ====================
        function renderCharts(filtered) {
            // 1. Tags bar chart (top 10)
            const tagCounts = {};
            filtered.forEach(row => {
                getAllTags(row).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            
            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const tagsLabels = sortedTags.map(t => t[0]);
            const tagsData = sortedTags.map(t => t[1]);

            if (tagsChartInstance) tagsChartInstance.destroy();
            tagsChartInstance = new Chart(document.getElementById('tagsChart'), {
                type: 'bar',
                data: {
                    labels: tagsLabels,
                    datasets: [{
                        label: 'Occurrences',
                        data: tagsData,
                        backgroundColor: '#10b981',
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#a1a1aa' } },
                        x: { grid: { color: '#27272a' }, ticks: { color: '#a1a1aa', maxRotation: 45, minRotation: 45 } }
                    }
                }
            });

            // 2. Content type doughnut
            const typeCounts = {};
            filtered.forEach(row => {
                const type = row["Type de contenu"];
                if (type) typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const typeLabels = Object.keys(typeCounts);
            const typeData = Object.values(typeCounts);
            const typeColors = ['#10b981', '#22d3ee', '#a78bfa', '#f87171', '#fbbf24', '#60a5fa'];

            if (typeChartInstance) typeChartInstance.destroy();
            typeChartInstance = new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        data: typeData,
                        backgroundColor: typeColors,
                        borderColor: '#18181b',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#d1d5db', padding: 20, usePointStyle: true }
                        }
                    }
                }
            });

            // 3. Urgency bar
            const urgencyCounts = {};
            filtered.forEach(row => {
                const urg = row["Niveau d'urgence / Cat√©gorie"];
                if (urg) urgencyCounts[urg] = (urgencyCounts[urg] || 0) + 1;
            });

            const urgencyLabels = Object.keys(urgencyCounts);
            const urgencyData = Object.values(urgencyCounts);

            if (urgencyChartInstance) urgencyChartInstance.destroy();
            urgencyChartInstance = new Chart(document.getElementById('urgencyChart'), {
                type: 'bar',
                data: {
                    labels: urgencyLabels,
                    datasets: [{
                        label: 'Nombre de signalements',
                        data: urgencyData,
                        backgroundColor: ['#10b981', '#eab308', '#f43f5e', '#8b5cf6', '#06b67f'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#a1a1aa' } },
                        x: { grid: { color: '#27272a' }, ticks: { color: '#a1a1aa' } }
                    }
                }
            });
        }

        // ==================== RENDER TABLE ====================
        function renderTable(filtered) {
            // Sort by date descending
            const sorted = [...filtered].sort((a, b) => {
                const dateA = new Date(a["Date du contenu"]);
                const dateB = new Date(b["Date du contenu"]);
                return isNaN(dateB) ? -1 : isNaN(dateA) ? 1 : dateB - dateA;
            }).slice(0, 15);

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            sorted.forEach(row => {
                const tags = getAllTags(row);
                const dateFormatted = formatDate(row["Date du contenu"]);
                const summary = (row["R√©sum√© bref du contenu"] || '').substring(0, 120) + 
                               ((row["R√©sum√© bref du contenu"] || '').length > 120 ? '‚Ä¶' : '');
                
                let urgencyClass = 'bg-zinc-700 text-zinc-300';
                const urgencyText = row["Niveau d'urgence / Cat√©gorie"] || '‚Äî';
                
                if (urgencyText.includes('Urgent')) urgencyClass = 'bg-red-500/10 text-red-400 border border-red-500/30';
                else if (urgencyText.includes('Success')) urgencyClass = 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/30';
                else if (urgencyText.includes('Probl√®me')) urgencyClass = 'bg-amber-500/10 text-amber-400 border border-amber-500/30';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-zinc-800/50 transition-colors';
                tr.innerHTML = `
                    <td class="px-8 py-6 text-zinc-400 whitespace-nowrap">${dateFormatted}</td>
                    <td class="px-8 py-6 max-w-xs">${summary}</td>
                    <td class="px-8 py-6">
                        <div class="flex flex-wrap gap-1 text-[10px] text-emerald-300">
                            ${tags.map(t => `<span class="bg-zinc-800 px-2.5 py-px rounded">${t}</span>`).join('')}
                        </div>
                    </td>
                    <td class="px-8 py-6">
                        <span class="inline-block px-4 py-1 text-xs font-medium rounded-2xl ${urgencyClass}">
                            ${urgencyText}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('table-count').textContent = `${sorted.length} entr√©es affich√©es`;
        }

        // ==================== FILTERS ====================
        function populateFilters() {
            // Urgency
            const urgencies = [...new Set(allData.map(r => r["Niveau d'urgence / Cat√©gorie"]).filter(Boolean))].sort();
            const urgencySelect = document.getElementById('urgency-filter');
            urgencySelect.innerHTML = `<option value="">Tous les niveaux</option>`;
            urgencies.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                urgencySelect.appendChild(opt);
            });

            // Platforms
            const platforms = [...new Set(allData.map(r => r["Plateforme d'origine"]).filter(Boolean))].sort();
            const platformSelect = document.getElementById('platform-filter');
            platformSelect.innerHTML = `<option value="">Toutes les plateformes</option>`;
            platforms.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                platformSelect.appendChild(opt);
            });

            // Themes
            const allTags = new Set();
            allData.forEach(row => {
                getAllTags(row).forEach(t => allTags.add(t));
            });
            const sortedTags = Array.from(allTags).sort();
            const themeSelect = document.getElementById('theme-filter');
            themeSelect.innerHTML = `<option value="">Tous les th√®mes</option>`;
            sortedTags.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                themeSelect.appendChild(opt);
            });
        }

        function getFilteredData() {
            let filtered = [...allData];

            const urgencyVal = document.getElementById('urgency-filter').value;
            if (urgencyVal) {
                filtered = filtered.filter(r => r["Niveau d'urgence / Cat√©gorie"] === urgencyVal);
            }

            const themeVal = document.getElementById('theme-filter').value;
            if (themeVal) {
                filtered = filtered.filter(r => getAllTags(r).includes(themeVal));
            }

            const platformVal = document.getElementById('platform-filter').value;
            if (platformVal) {
                filtered = filtered.filter(r => r["Plateforme d'origine"] === platformVal);
            }

            return filtered;
        }

        function updateDashboard() {
            const filtered = getFilteredData();
            renderMetrics(filtered);
            renderCharts(filtered);
            renderTable(filtered);
        }

        function resetFilters() {
            document.getElementById('urgency-filter').value = '';
            document.getElementById('theme-filter').value = '';
            document.getElementById('platform-filter').value = '';
            updateDashboard();
        }

        // ==================== MAIN LOAD ====================
        async function loadDashboard() {
            const errorOverlay = document.getElementById('error-overlay');
            
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Impossible de r√©cup√©rer le fichier CSV');
                
                const csvText = await response.text();
                const parsedRows = parseCSV(csvText);
                
                if (parsedRows.length < 2) throw new Error('Aucune donn√©e trouv√©e');
                
                // Create headers
                const headers = parsedRows[0].map(h => h.trim());
                
                // Create data objects
                allData = parsedRows.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = (row[i] || '').trim();
                    });
                    return obj;
                }).filter(row => row["Date du contenu"]); // remove empty rows

                //if (allData.length === 0) throw new Error('Aucune ligne valide');

                // Populate filters
                populateFilters();
                
                // First render
                updateDashboard();
                
                // Update last updated
                document.getElementById('last-updated').textContent = 
                    'Derni√®re mise √† jour : ' + new Date().toLocaleTimeString('fr-FR');

            } catch (err) {
                console.error(err);
                document.getElementById('error-message').textContent = err.message || 'Erreur inconnue lors du chargement des donn√©es.';
                errorOverlay.classList.remove('hidden');
            }
        }

        // Tailwind script already loaded via CDN
        window.onload = loadDashboard;
    </script>
</body>

</html>
