<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPB Dashboard • Intelligence par la Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap');
        body { font-family: 'Inter', system-ui, sans-serif; }
        .title-font { font-family: 'Space Grotesk', sans-serif; }
        .card { transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.08); }
        .video-icon-link {
          display: inline-block; /* Allows width/height and padding */
          line-height: 0; /* Remove extra space below SVG */
          padding: 5px; /* Optional padding around the icon */
          border-radius: 4px; /* Slightly rounded corners */
          transition: background-color 0.2s ease; /* Smooth hover effect */
          color: #3b82f6; /* Default icon color (e.g., a blue) */
        }
        
        .video-icon-link:hover {
          background-color: rgba(59, 130, 246, 0.1); /* Light background on hover */
          color: #2563eb; /* Darker blue on hover */
        }
        
        .video-icon {
          width: 24px; /* Set your desired icon size */
          height: 24px;
          vertical-align: middle; /* Align icon nicely if there's surrounding text */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header – match style from Savoir Partagé -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-10 gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-md">IPB</div>
                <div>
                    <h1 class="title-font text-3xl sm:text-4xl font-semibold tracking-tight text-gray-900">Intelligence par la Base</h1>
                    <p class="text-emerald-700 text-base sm:text-lg">Analyse des réalités de terrain en RCA</p>
                </div>
            </div>
            <div class="text-sm text-gray-500 flex items-center gap-2">
                <div class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium">Données en direct</div>
                <span id="last-updated"></span>
            </div>
        </div>

        <!-- Metrics – white cards like Savoir Partagé -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10" id="metrics"></div>

        <!-- Filters – white background, rounded-xl -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Niveau d'urgence</label>
                    <select id="urgency-filter" onchange="updateDashboard()" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition">
                        <option value="">Tous les niveaux</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Thème / Tag</label>
                    <select id="theme-filter" onchange="updateDashboard()" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition">
                        <option value="">Tous les thèmes</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Plateforme</label>
                    <select id="platform-filter" onchange="updateDashboard()" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition">
                        <option value="">Toutes les plateformes</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="resetFilters()" class="w-full bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-xl py-3 px-4 text-sm font-medium transition-colors">
                        Réinitialiser
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts Grid – same as Savoir Partagé -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                <h3 class="font-semibold text-lg mb-5 text-gray-800">Distribution des thèmes</h3>
                <div class="h-72"><canvas id="tagsChart"></canvas></div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                <h3 class="font-semibold text-lg mb-5 text-gray-800">Type de contenu</h3>
                <div class="h-72"><canvas id="typeChart"></canvas></div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                <h3 class="font-semibold text-lg mb-5 text-gray-800">Niveau d'urgence</h3>
                <div class="h-72"><canvas id="urgencyChart"></canvas></div>
            </div>
        </div>

        <!-- Table – light version -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Soumissions récentes</h2>
                    <p class="text-sm text-gray-500">15 dernières entrées (triées par date)</p>
                </div>
                <div id="table-count" class="text-sm text-gray-600 font-medium"></div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Résumé</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thèmes</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Urgence</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contenu Brut</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Error overlay – light version -->
    <div id="error-overlay" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 text-center shadow-2xl">
            <div class="text-6xl mb-4">⚠️</div>
            <h3 class="text-xl font-bold mb-3 text-gray-900">Erreur de chargement</h3>
            <p id="error-message" class="text-gray-600 mb-6"></p>
            <button onclick="location.reload()" class="px-8 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-medium transition">
                Réessayer
            </button>
        </div>
    </div>

 <script>
        // ==================== CONFIG ====================
       // const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb6ZvGw9im_FrK9riRIUwe5vQ3YBJ5dOknOhC7T4bYchlK_1I9nSJ7nM0Es4jzHmYDO7hDUfxn94HY/pub?gid=137328810&single=true&output=csv";
        //const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb6ZvGw9im_FrK9riRIUwe5vQ3YBJ5dOknOhC7T4bYchlK_1I9nSJ7nM0Es4jzHmYDO7hDUfxn94HY/pub?output=csv";
        //const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQb6ZvGw9im_FrK9riRIUwe5vQ3YBJ5dOknOhC7T4bYchlK_1I9nSJ7nM0Es4jzHmYDO7hDUfxn94HY/export?format=csv&gid=137328810";
const CSV_URL = "https://script.google.com/macros/s/AKfycbzg0Ch-kElonNhVguxO33ehFsQ7qfDdtOoMJ-yTmYB7HSohrROIaiKSAIt_TEft5zE1KA/exec";
        

        const THEME_COLUMNS = [
            "Thèmes 2/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 3/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 4/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 5/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 6/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 8/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 7/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 9/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 10/ Tags principaux (choisissez 1 à 3)"
        ];

        // ==================== CSV PARSER ====================
        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let row = 0;
            let col = 0;
            for (let i = 0; i < str.length; i++) {
                const cc = str[i];
                const nc = str[i + 1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';
                
                if (cc === '"' && quote && nc === '"') {
                    arr[row][col] += cc;
                    i++;
                    continue;
                }
                if (cc === '"') {
                    quote = !quote;
                    continue;
                }
                if (cc === ',' && !quote) {
                    col++;
                    continue;
                }
                if (cc === '\r' && nc === '\n' && !quote) {
                    i++;
                    row++;
                    col = 0;
                    continue;
                }
                if (cc === '\n' && !quote) {
                    row++;
                    col = 0;
                    continue;
                }
                if (cc === '\r' && !quote) {
                    row++;
                    col = 0;
                    continue;
                }
                arr[row][col] += cc;
            }
            return arr;
        }

        // ==================== DATA HELPERS ====================
        let allData = [];
        let tagsChartInstance = null;
        let typeChartInstance = null;
        let urgencyChartInstance = null;

        function getAllTags(row) {
            const tags = new Set();
            THEME_COLUMNS.forEach(col => {
                const cell = row[col];
                if (cell) {
                    const parts = cell.split(/\s+/);
                    parts.forEach(p => {
                        const trimmed = p.trim();
                        if (trimmed.startsWith('#') && trimmed.length > 1) {
                           tags.add(trimmed);
                        }
                    });
                }
            });
            return Array.from(tags);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // ==================== RENDER METRICS ====================
        function renderMetrics(filtered) {
            const total = filtered.length;
            const uniqueSubmitters = new Set(filtered.map(r => r["Votre nom complet"]).filter(Boolean)).size;
            
            // Urgent count
            const urgentCount = filtered.filter(r => 
                r["Niveau d'urgence / Catégorie"] === "Urgent / Appel à l'aide"
            ).length;

            // Most frequent tag
            const tagCounts = {};
            filtered.forEach(row => {
                getAllTags(row).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
            const mostFreqTag = sortedTags.length ? `${sortedTags[0][0]} <span class="text-emerald-400">(${sortedTags[0][1]})</span>` : '—';

            const metricsHTML = `
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card">
                    <div class="text-emerald-400 text-4xl font-bold mb-1" id="total-count">${total}</div>
                    <div class="text-zinc-400 text-sm">Soumissions totales</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card">
                    <div class="text-white text-4xl font-bold mb-1">${uniqueSubmitters}</div>
                    <div class="text-zinc-400 text-sm">Contributeurs uniques</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card">
                    <div class="text-amber-400 text-4xl font-bold mb-1">${mostFreqTag}</div>
                    <div class="text-zinc-400 text-sm">Thème le plus fréquent</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 card relative overflow-hidden">
                    <div class="text-red-400 text-4xl font-bold mb-1">${urgentCount}</div>
                    <div class="text-zinc-400 text-sm">Appels à l'aide urgents</div>
                    ${urgentCount > 0 ? `<div class="absolute top-4 right-4 text-xs bg-red-500/10 text-red-400 px-3 py-1 rounded-full">Priorité</div>` : ''}
                </div>
            `;
            
            document.getElementById('metrics').innerHTML = metricsHTML;
        }

        // ==================== RENDER CHARTS ====================
        function renderCharts(filtered) {
            // 1. Tags bar chart (top 10)
            const tagCounts = {};
            filtered.forEach(row => {
                getAllTags(row).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            
            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const tagsLabels = sortedTags.map(t => t[0]);
            const tagsData = sortedTags.map(t => t[1]);

            if (tagsChartInstance) tagsChartInstance.destroy();
            tagsChartInstance = new Chart(document.getElementById('tagsChart'), {
                type: 'bar',
                data: {
                    labels: tagsLabels,
                    datasets: [{
                        label: 'Occurrences',
                        data: tagsData,
                        backgroundColor: '#10b981',
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#a1a1aa' } },
                        x: { grid: { color: '#27272a' }, ticks: { color: '#a1a1aa', maxRotation: 45, minRotation: 45 } }
                    }
                }
            });

            // 2. Content type doughnut
            const typeCounts = {};
            filtered.forEach(row => {
                const type = row["Type de contenu"];
                if (type) typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const typeLabels = Object.keys(typeCounts);
            const typeData = Object.values(typeCounts);
            const typeColors = ['#10b981', '#22d3ee', '#a78bfa', '#f87171', '#fbbf24', '#60a5fa'];

            if (typeChartInstance) typeChartInstance.destroy();
            typeChartInstance = new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        data: typeData,
                        backgroundColor: typeColors,
                        borderColor: '#18181b',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#d1d5db', padding: 20, usePointStyle: true }
                        }
                    }
                }
            });

            // 3. Urgency bar
            const urgencyCounts = {};
            filtered.forEach(row => {
                const urg = row["Niveau d'urgence / Catégorie"];
                if (urg) urgencyCounts[urg] = (urgencyCounts[urg] || 0) + 1;
            });

            const urgencyLabels = Object.keys(urgencyCounts);
            const urgencyData = Object.values(urgencyCounts);

            if (urgencyChartInstance) urgencyChartInstance.destroy();
            urgencyChartInstance = new Chart(document.getElementById('urgencyChart'), {
                type: 'bar',
                data: {
                    labels: urgencyLabels,
                    datasets: [{
                        label: 'Nombre de signalements',
                        data: urgencyData,
                        backgroundColor: ['#10b981', '#eab308', '#f43f5e', '#8b5cf6', '#06b67f'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#a1a1aa' } },
                        x: { grid: { color: '#27272a' }, ticks: { color: '#a1a1aa' } }
                    }
                }
            });
        }

        // ==================== RENDER TABLE ====================
        function renderTable(filtered) {
            // Sort by date descending
            const sorted = [...filtered].sort((a, b) => {
                const dateA = new Date(a["Date du contenu (si connue)"]);
                const dateB = new Date(b["Date du contenu (si connue)"]);
                return isNaN(dateB) ? -1 : isNaN(dateA) ? 1 : dateB - dateA;
            }).slice(0, 15);

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            sorted.forEach(row => {
                const tags = getAllTags(row);
                const dateFormatted = formatDate(row["Date du contenu (si connue)"]);
                const summary = (row["Résumé bref du contenu (1-2 phrases)"] || '').substring(0, 120) + 
                               ((row["Résumé bref du contenu (1-2 phrases)"] || '').length > 120 ? '…' : '');
                
                let urgencyClass = 'bg-zinc-700 text-zinc-300';
                const urgencyText = row["Niveau d'urgence / Catégorie"] || '—';
                const content = row["Fichier Téléchargé ?"];
                let selectedVideoTd = `<td class="px-8 py-6">
                      <a href="${content}" target="_blank" rel="noopener noreferrer" class="video-icon-link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="video-icon">
                          <path d="M7.294 18.062c-.083.05-.183.05-.264 0-.462-.27-.729-.778-.729-1.312V7.25c0-.534.267-1.042.729-1.312.462-.27.973-.243 1.401.071l7.653 5.438c.428.314.675.822.675 1.353s-.247 1.039-.675 1.353l-7.653 5.438c-.428.314-.939.341-1.401.071Z"/>
                        </svg>
                      </a>
                    </td>
                    `;
if (content.length <= 0) {
    selectedVideoTd =  `<td class="px-8 py-6">—</td>`;
}
                
                if (urgencyText.includes('Urgent')) urgencyClass = 'bg-red-500/10 text-red-400 border border-red-500/30';
                else if (urgencyText.includes('Success')) urgencyClass = 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/30';
                else if (urgencyText.includes('Problème')) urgencyClass = 'bg-amber-500/10 text-amber-400 border border-amber-500/30';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-zinc-800/50 transition-colors';
                tr.innerHTML = `
                    <td class="px-8 py-6 text-zinc-400 whitespace-nowrap">${dateFormatted}</td>
                    <td class="px-8 py-6 max-w-xs">${summary}</td>
                    <td class="px-8 py-6">
                        <div class="flex flex-wrap gap-1 text-[10px] text-emerald-300">
                            ${tags.map(t => `<span class="bg-zinc-800 px-2.5 py-px rounded">${t}</span>`).join('')}
                        </div>
                    </td>
                    <td class="px-8 py-6">
                        <span class="inline-block px-4 py-1 text-xs font-medium rounded-2xl ${urgencyClass}">
                            ${urgencyText}
                        </span>
                    </td>
                    ${selectedVideoTd}
                    `
                tbody.appendChild(tr);
            });

            document.getElementById('table-count').textContent = `${sorted.length} entrées affichées`;
        }

        // ==================== FILTERS ====================
        function populateFilters() {
            // Urgency
            const urgencies = [...new Set(allData.map(r => r["Niveau d'urgence / Catégorie"]).filter(Boolean))].sort();
            const urgencySelect = document.getElementById('urgency-filter');
            urgencySelect.innerHTML = `<option value="">Tous les niveaux</option>`;
            urgencies.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                urgencySelect.appendChild(opt);
            });

            // Platforms
            const platforms = [...new Set(allData.map(r => r["Plateforme d'origine"]).filter(Boolean))].sort();
            const platformSelect = document.getElementById('platform-filter');
            platformSelect.innerHTML = `<option value="">Toutes les plateformes</option>`;
            platforms.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                platformSelect.appendChild(opt);
            });

            // Themes
            const allTags = new Set();
            allData.forEach(row => {
                getAllTags(row).forEach(t => allTags.add(t));
            });
            const sortedTags = Array.from(allTags).sort();
            const themeSelect = document.getElementById('theme-filter');
            themeSelect.innerHTML = `<option value="">Tous les thèmes</option>`;
            sortedTags.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                themeSelect.appendChild(opt);
            });
        }

        function getFilteredData() {
            let filtered = [...allData];

            const urgencyVal = document.getElementById('urgency-filter').value;
            if (urgencyVal) {
                filtered = filtered.filter(r => r["Niveau d'urgence / Catégorie"] === urgencyVal);
            }

            const themeVal = document.getElementById('theme-filter').value;
            if (themeVal) {
                filtered = filtered.filter(r => getAllTags(r).includes(themeVal));
            }

            const platformVal = document.getElementById('platform-filter').value;
            if (platformVal) {
                filtered = filtered.filter(r => r["Plateforme d'origine"] === platformVal);
            }

            return filtered;
        }

        function updateDashboard() {
            const filtered = getFilteredData();
            renderMetrics(filtered);
            renderCharts(filtered);
            renderTable(filtered);
        }

        function resetFilters() {
            document.getElementById('urgency-filter').value = '';
            document.getElementById('theme-filter').value = '';
            document.getElementById('platform-filter').value = '';
            updateDashboard();
        }

        // ==================== MAIN LOAD ====================
async function loadDashboard() {
    const errorOverlay = document.getElementById('error-overlay');
    
    try {
        const SPREADSHEET_ID = '1qo33mlAhLdedEjFFZSP_j6CyF5Atdnuy1L9jd7vjyvc';
        const API_KEY = 'AIzaSyCYRoIiIE95yZlaHbcxAKxS8iqD2rJZfD0';  // Keep yours
        const SHEET_NAME = 'Form Responses 1';

        const range = encodeURIComponent(`${SHEET_NAME}!A:Z`);
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;

        const response = await fetch(url);
        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`Sheets API error: ${response.status} - ${errText}`);
        }

        const data = await response.json();
        const rows = data.values || [];

        if (rows.length < 2) {
            throw new Error('No data found in sheet');
        }

        // Headers from row 0
        const headers = rows[0].map(h => h.trim());

        // Updated theme columns based on actual sheet
        const THEME_COLUMNS = [
            "Thèmes 2/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 3/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 4/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 5/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 6/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 7/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 8/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 9/ Tags principaux (choisissez 1 à 3)",
            "Thèmes 10/ Tags principaux (choisissez 1 à 3)"
        ];

        // Build data objects
        allData = rows.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, i) => {
                obj[header] = (row[i] || '').trim();
            });
            return obj;
        }).filter(row => {
            // More forgiving filter: check multiple possible date fields
            const dateField = row["Date du contenu (si connue)"] || row["Date du contenu"] || '';
            return dateField && dateField.trim() !== '';
        });

        console.log('Parsed rows:', allData.length);               // Should be 5
        console.log('First entry:', allData[0]);                   // Inspect in browser console (F12)
        console.log('Sample themes from first row:', getAllTags(allData[0]));

        if (allData.length === 0) {
            throw new Error('Aucune ligne valide après filtrage – vérifiez les noms de colonnes');
        }

        populateFilters();
        updateDashboard();

        document.getElementById('last-updated').textContent = 
            'Dernière mise à jour : ' + new Date().toLocaleTimeString('fr-FR');

    } catch (err) {
        console.error(err);
        document.getElementById('error-message').textContent = err.message || 'Erreur lors du chargement.';
        errorOverlay.classList.remove('hidden');
    }
}

        // Tailwind script already loaded via CDN
        window.onload = loadDashboard;
    </script>
</body>

</html>










